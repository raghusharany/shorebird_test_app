name: Shorebird Release Pipeline

on:
  # Manual trigger via GitHub Actions UI
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment/Flavor (dev, staging, production)'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      release_type:
        description: 'Shorebird Release Type'
        required: true
        type: choice
        default: native_release
        options:
          - native_release    # New native release with version bump (default)
          - first_release     # Initial Shorebird release - creates a new release
      version_increment:
        description: 'Version Increment Type (for native_release only)'
        required: false
        type: choice
        options:
          - none
          - patch
          - minor
          - major
        default: none
  # Tag-based trigger (e.g., v1.0.0)
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+" # e.g. v1.0.0

# Define required permissions
permissions:
  contents: write    # For creating and pushing tags, updating pubspec.yaml
  checks: read       # For reading CI status
  actions: write     # For uploading artifacts

env:
  SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
  FLUTTER_VERSION: '3.27.2'  # Matching your Flutter version

jobs:
  # ============================================================================
  # JOB 1: Pre-release CI Checks
  # ============================================================================
  run-ci-checks:
    name: Pre-release CI Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install Dependencies
        run: flutter pub get

      - name: Run Linter
        run: flutter analyze

      - name: Run Tests
        run: flutter test

  # ============================================================================
  # JOB 2: Shorebird Release
  # ============================================================================
  shorebird-release:
    needs: run-ci-checks
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------------------
      # Setup and Preparation
      # ------------------------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for git tags
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}

      # Setup Shorebird using official GitHub Action
      - name: ðŸ¦ Setup Shorebird
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      # Setup Java (required for Android builds)
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: gradle

      # Setup Flutter
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      # ------------------------------------------------------------------------
      # Determine Environment
      # ------------------------------------------------------------------------
      - name: Determine Environment
        id: environment_config
        run: |
          # Check if triggered by tag or workflow_dispatch
          if [ -n "${{ github.ref_type }}" ] && [ "${{ github.ref_type }}" = "tag" ]; then
            # Tag-based trigger - default to production
            ENVIRONMENT="production"
            echo "Tag-based trigger - using production environment"
          else
            # Manual workflow_dispatch trigger
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            echo "Manual trigger - using environment: $ENVIRONMENT"
          fi
          
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------------
      # Version Management
      # ------------------------------------------------------------------------
      - name: Calculate Version and Build Number
        id: version
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
        run: |
          # Check if triggered by tag or workflow_dispatch
          if [ -n "${{ github.ref_type }}" ] && [ "${{ github.ref_type }}" = "tag" ]; then
            # Extract version from tag (e.g., v1.0.0 -> 1.0.0)
            TAG_VERSION="${{ github.ref_name }}"
            NEXT_VERSION=$(echo "$TAG_VERSION" | sed 's/^v//')
            
            # Get the latest Shorebird tag for this environment to determine build number
            ENVIRONMENT="${{ steps.environment_config.outputs.environment }}"
            LATEST_TAG=$(git tag -l "shorebird_release_${ENVIRONMENT}_*" | sort -V | tail -n 1)
            if [ -z "$LATEST_TAG" ]; then
              NEXT_BUILD=1
            else
              LATEST_BUILD=$(echo "$LATEST_TAG" | sed -n 's/.*+\([0-9]\+\)$/\1/p')
              if [ -z "$LATEST_BUILD" ]; then
                NEXT_BUILD=1
              else
                NEXT_BUILD=$((LATEST_BUILD + 1))
              fi
            fi
            
            RELEASE_TYPE="native_release"
            echo "Tag-based trigger detected: $TAG_VERSION"
          else
            # Manual workflow_dispatch trigger
            # Get the latest Shorebird tag for this environment (primary source of truth)
            ENVIRONMENT="${{ steps.environment_config.outputs.environment }}"
            LATEST_TAG=$(git tag -l "shorebird_release_${ENVIRONMENT}_*" | sort -V | tail -n 1)
            
            # Determine version based on release type
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
            
            if [ -z "$LATEST_TAG" ]; then
              # No tags exist - use pubspec.yaml as fallback for first release
              CURRENT_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
              CURRENT_BUILD=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
              echo "No existing tags found for $ENVIRONMENT, using pubspec.yaml: $CURRENT_VERSION+$CURRENT_BUILD"
              
              if [[ "$RELEASE_TYPE" == "native_release" ]]; then
                # For native release, calculate next version based on increment type
                if [ "${{ github.event.inputs.version_increment }}" != "none" ]; then
                  IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
                  
                  case "${{ github.event.inputs.version_increment }}" in
                    "major") NEXT_VERSION="$((major + 1)).0.0" ;;
                    "minor") NEXT_VERSION="${major}.$((minor + 1)).0" ;;
                    "patch") NEXT_VERSION="${major}.${minor}.$((patch + 1))" ;;
                    *) NEXT_VERSION="$CURRENT_VERSION" ;;
                  esac
                  echo "Incrementing version from $CURRENT_VERSION to $NEXT_VERSION"
                else
                  NEXT_VERSION="$CURRENT_VERSION"
                fi
                # For first release with no tags, start at build 1
                NEXT_BUILD=1
              else
                # For first_release - use current version from pubspec.yaml, start at build 1
                NEXT_VERSION="$CURRENT_VERSION"
                # Check if any releases exist in Shorebird for this version
                echo "Checking Shorebird for existing releases with version $NEXT_VERSION..."
                SHOREBIRD_BUILD=$(shorebird releases list --platform android 2>/dev/null | \
                  grep "${NEXT_VERSION}" | \
                  grep -oE '\+[0-9]+' | \
                  sed 's/\+//' | \
                  sort -n | \
                  tail -1 || echo "")
                
                if [ -n "$SHOREBIRD_BUILD" ] && [ "$SHOREBIRD_BUILD" -gt 0 ] 2>/dev/null; then
                  echo "Found existing release in Shorebird: ${NEXT_VERSION}+${SHOREBIRD_BUILD}"
                  NEXT_BUILD=$((SHOREBIRD_BUILD + 1))
                  echo "Starting from build number: $NEXT_BUILD (incremented from Shorebird)"
                else
                  NEXT_BUILD=1
                  echo "No existing releases found in Shorebird, starting with build 1"
                fi
              fi
            else
              # Tags exist - extract version from latest tag (source of truth)
              echo "Latest Shorebird tag found for $ENVIRONMENT: $LATEST_TAG"
              
              # Extract version from tag (shorebird_release_dev_1.0.0+1 -> 1.0.0)
              CURRENT_VERSION=$(echo "$LATEST_TAG" | sed "s/shorebird_release_${ENVIRONMENT}_//" | sed 's/+.*//')
              CURRENT_BUILD=$(echo "$LATEST_TAG" | sed -n 's/.*+\([0-9]\+\)$/\1/p')
              
              echo "Current version from latest tag: $CURRENT_VERSION+$CURRENT_BUILD"
              
              if [[ "$RELEASE_TYPE" == "native_release" ]]; then
                # For native release, calculate next version based on increment type
                if [ "${{ github.event.inputs.version_increment }}" != "none" ]; then
                  IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
                  
                  case "${{ github.event.inputs.version_increment }}" in
                    "major") NEXT_VERSION="$((major + 1)).0.0" ;;
                    "minor") NEXT_VERSION="${major}.$((minor + 1)).0" ;;
                    "patch") NEXT_VERSION="${major}.${minor}.$((patch + 1))" ;;
                    *) NEXT_VERSION="$CURRENT_VERSION" ;;
                  esac
                  echo "Incrementing version from $CURRENT_VERSION to $NEXT_VERSION"
                else
                  NEXT_VERSION="$CURRENT_VERSION"
                  echo "Keeping current version: $NEXT_VERSION (version_increment: none)"
                fi
                
                # Calculate initial build number from git tags
                INITIAL_BUILD=$((CURRENT_BUILD + 1))
                
                # When version_increment is "none", check Shorebird for existing releases
                # to find the next available build number for this version
                if [ "${{ github.event.inputs.version_increment }}" == "none" ]; then
                  echo "Version increment is 'none' - checking Shorebird for existing releases..."
                  
                  # Start with the build number from git tags
                  NEXT_BUILD=$INITIAL_BUILD
                  
                  # Check if this version+build already exists in Shorebird
                  # Keep incrementing until we find an available build number
                  MAX_ATTEMPTS=20
                  ATTEMPT=0
                  
                  while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
                    TEST_VERSION="${NEXT_VERSION}+${NEXT_BUILD}"
                    echo "Checking if release ${TEST_VERSION} exists in Shorebird..."
                    
                    # Try to get release info - if it exists, command will succeed
                    # If it doesn't exist, it will fail
                    if shorebird releases list --platform android 2>/dev/null | grep -q "${TEST_VERSION}"; then
                      echo "âš ï¸ Release ${TEST_VERSION} already exists in Shorebird, trying next build number..."
                      NEXT_BUILD=$((NEXT_BUILD + 1))
                      ATTEMPT=$((ATTEMPT + 1))
                    else
                      echo "âœ… Release ${TEST_VERSION} is available"
                      break
                    fi
                  done
                  
                  if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                    echo "âš ï¸ Warning: Checked $MAX_ATTEMPTS build numbers, using: $NEXT_BUILD"
                  fi
                  
                  echo "âœ… Final build number: $NEXT_BUILD"
                else
                  # For version increments (patch/minor/major), always increment from git tag
                  NEXT_BUILD=$INITIAL_BUILD
                  echo "Version incrementing, using build number: $NEXT_BUILD"
                fi
              else
                # For first_release - use version from tag, increment build
                NEXT_VERSION="$CURRENT_VERSION"
                NEXT_BUILD=$((CURRENT_BUILD + 1))
                echo "First release for this version, incrementing build: $NEXT_BUILD"
              fi
            fi
          fi
          
          # Format the version strings
          ENVIRONMENT="${{ steps.environment_config.outputs.environment }}"
          FULL_VERSION="${NEXT_VERSION}+${NEXT_BUILD}"
          TAG_VERSION="shorebird_release_${ENVIRONMENT}_${NEXT_VERSION}+${NEXT_BUILD}"
          
          echo "Full version: $FULL_VERSION"
          echo "Tag version: $TAG_VERSION"
          echo "Release type: $RELEASE_TYPE"
          
          # Set outputs
          echo "version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "build=$NEXT_BUILD" >> $GITHUB_OUTPUT
          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
          
          # Validation
          if [ -z "$NEXT_BUILD" ] || [ "$NEXT_BUILD" -lt 1 ]; then
            echo "ERROR: Invalid build number: '$NEXT_BUILD'"
            exit 1
          fi
          
          if [ -z "$NEXT_VERSION" ]; then
            echo "ERROR: Invalid version: '$NEXT_VERSION'"
            exit 1
          fi

      # ------------------------------------------------------------------------
      # Shorebird Release Build
      # ------------------------------------------------------------------------
      - name: Install Dependencies
        run: |
          flutter pub get

      # ------------------------------------------------------------------------
      # Shorebird Release with Auto-Retry on Build Number Conflict
      # ------------------------------------------------------------------------
      - name: ðŸš€ Shorebird Release (with auto-retry)
        id: shorebird-release
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
        run: |
          ENVIRONMENT="${{ steps.environment_config.outputs.environment }}"
          VERSION="${{ steps.version.outputs.version }}"
          INITIAL_BUILD="${{ steps.version.outputs.build }}"
          CURRENT_BUILD=$INITIAL_BUILD
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempting to create release: ${VERSION}+${CURRENT_BUILD}"
            
            # Try to create the release
            if shorebird release android \
              --flutter-version ${{ env.FLUTTER_VERSION }} \
              --flavor "$ENVIRONMENT" \
              --dart-define=ENVIRONMENT="$ENVIRONMENT" \
              --artifact=apk \
              --build-name="$VERSION" \
              --build-number="$CURRENT_BUILD" \
              --verbose 2>&1 | tee release_output.log; then
              
              echo "âœ… Successfully created release: ${VERSION}+${CURRENT_BUILD}"
              echo "build_number=$CURRENT_BUILD" >> $GITHUB_OUTPUT
              echo "full_version=${VERSION}+${CURRENT_BUILD}" >> $GITHUB_OUTPUT
              break
            else
              EXIT_CODE=${PIPESTATUS[0]}
              # Check if error is due to existing release
              if grep -q "existing.*release.*version.*${VERSION}\+${CURRENT_BUILD}" release_output.log 2>/dev/null || \
                 grep -q "existing android release for version ${VERSION}\+${CURRENT_BUILD}" release_output.log 2>/dev/null; then
                echo "âš ï¸ Release ${VERSION}+${CURRENT_BUILD} already exists, incrementing build number..."
                CURRENT_BUILD=$((CURRENT_BUILD + 1))
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "Retrying with build number: $CURRENT_BUILD"
              else
                echo "âŒ Release failed for a different reason. Check logs above."
                cat release_output.log
                exit $EXIT_CODE
              fi
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "âŒ Error: Could not find available build number after $MAX_RETRIES attempts"
            exit 1
          fi
          
          # Update the version outputs if build number changed
          if [ "$CURRENT_BUILD" != "$INITIAL_BUILD" ]; then
            echo "âš ï¸ Build number was adjusted from $INITIAL_BUILD to $CURRENT_BUILD"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "build=$CURRENT_BUILD" >> $GITHUB_OUTPUT
            echo "full_version=${VERSION}+${CURRENT_BUILD}" >> $GITHUB_OUTPUT
            echo "tag_version=shorebird_release_${ENVIRONMENT}_${VERSION}+${CURRENT_BUILD}" >> $GITHUB_OUTPUT
          else
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "build=$CURRENT_BUILD" >> $GITHUB_OUTPUT
            echo "full_version=${VERSION}+${CURRENT_BUILD}" >> $GITHUB_OUTPUT
            echo "tag_version=shorebird_release_${ENVIRONMENT}_${VERSION}+${CURRENT_BUILD}" >> $GITHUB_OUTPUT
          fi

      # ------------------------------------------------------------------------
      # Copy and Prepare APK Artifact
      # ------------------------------------------------------------------------
      - name: Copy Release APK
        run: |
          mkdir -p artifacts
          
          ENVIRONMENT="${{ steps.environment_config.outputs.environment }}"
          
          # Find the Shorebird release APK (check flavor-specific locations)
          # With flavors, APK names include the flavor: app-dev-release.apk, app-staging-release.apk, etc.
          # Check multiple possible locations for flavor-specific builds
          SOURCE_APK=""
          
          # Try flavor-specific paths first
          if [ -f "build/app/outputs/flutter-apk/app-${ENVIRONMENT}-release.apk" ]; then
            SOURCE_APK="build/app/outputs/flutter-apk/app-${ENVIRONMENT}-release.apk"
          elif [ -f "build/app/outputs/apk/${ENVIRONMENT}/release/app-${ENVIRONMENT}-release.apk" ]; then
            SOURCE_APK="build/app/outputs/apk/${ENVIRONMENT}/release/app-${ENVIRONMENT}-release.apk"
          elif [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            # Fallback to non-flavor path (shouldn't happen with flavors, but just in case)
            SOURCE_APK="build/app/outputs/flutter-apk/app-release.apk"
          elif [ -f "build/app/outputs/apk/release/app-release.apk" ]; then
            # Fallback to non-flavor path
            SOURCE_APK="build/app/outputs/apk/release/app-release.apk"
          else
            echo "âŒ Error: Source APK not found for environment: $ENVIRONMENT"
            echo "Searched paths:"
            echo "  - build/app/outputs/flutter-apk/app-${ENVIRONMENT}-release.apk"
            echo "  - build/app/outputs/apk/${ENVIRONMENT}/release/app-${ENVIRONMENT}-release.apk"
            echo "  - build/app/outputs/flutter-apk/app-release.apk"
            echo "  - build/app/outputs/apk/release/app-release.apk"
            echo ""
            echo "Available APKs:"
            find build/app/outputs -name "*.apk" -type f
            exit 1
          fi
          
          echo "âœ… Found APK: $SOURCE_APK"
          TARGET_APK="app-${ENVIRONMENT}-${{ steps.shorebird-release.outputs.full_version }}-shorebird-release.apk"
          cp "$SOURCE_APK" "artifacts/$TARGET_APK"
          echo "âœ… Copied to: artifacts/$TARGET_APK"
          du -h "artifacts/$TARGET_APK"

      # ------------------------------------------------------------------------
      # Artifacts and Tagging
      # ------------------------------------------------------------------------
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: shorebird-release-${{ steps.environment_config.outputs.environment }}-${{ steps.shorebird-release.outputs.full_version }}
          path: artifacts/
          retention-days: 90

      # ------------------------------------------------------------------------
      # Update pubspec.yaml with new version
      # ------------------------------------------------------------------------
      - name: Update pubspec.yaml Version
        run: |
          NEW_VERSION="${{ steps.shorebird-release.outputs.version }}"
          NEW_BUILD="${{ steps.shorebird-release.outputs.build }}"
          
          # Update version in pubspec.yaml (works on both Linux and macOS)
          sed -i.bak "s/^version: .*/version: ${NEW_VERSION}+${NEW_BUILD}/" pubspec.yaml
          rm -f pubspec.yaml.bak
          
          echo "âœ… Updated pubspec.yaml to version: ${NEW_VERSION}+${NEW_BUILD}"
          echo "Current pubspec.yaml version line:"
          grep "^version:" pubspec.yaml

      - name: Commit and Push Version Update
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          # Check if there are changes to commit
          if git diff --quiet pubspec.yaml; then
            echo "â„¹ï¸ No version changes to commit (version already matches)"
          else
            git add pubspec.yaml
            git commit -m "chore: auto-update version to ${{ steps.shorebird-release.outputs.full_version }} [skip ci]"
            
            # Push to the branch (extract branch name from GITHUB_REF)
            if [[ "${{ github.ref }}" == refs/heads/* ]]; then
              BRANCH_NAME=${GITHUB_REF#refs/heads/}
              git push origin HEAD:$BRANCH_NAME
              echo "âœ… Committed and pushed version update to branch: $BRANCH_NAME"
            else
              # If triggered by tag or other ref, push to main/master
              git push origin HEAD:main 2>/dev/null || git push origin HEAD:master 2>/dev/null || echo "âš ï¸ Could not determine branch, version update not pushed"
            fi
          fi

      - name: Create Git Tag
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          TAG_NAME="${{ steps.shorebird-release.outputs.tag_version }}"
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"
          echo "âœ… Created and pushed tag: $TAG_NAME"

      # ------------------------------------------------------------------------
      # Notification and Summary
      # ------------------------------------------------------------------------
      - name: Generate Release Summary
        if: always()
        run: |
          echo "# ðŸš€ Shorebird Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Release Information" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.ref_type }}" ] && [ "${{ github.ref_type }}" = "tag" ]; then
            echo "- **Trigger:** Tag (${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
            echo "- **Release Type:** native_release" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Trigger:** Manual (workflow_dispatch)" >> $GITHUB_STEP_SUMMARY
            echo "- **Release Type:** ${{ github.event.inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Environment:** ${{ steps.environment_config.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Version:** ${{ steps.shorebird-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Build Number:** ${{ steps.shorebird-release.outputs.build }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Full Version:** ${{ steps.shorebird-release.outputs.full_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **Build Status:** Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Download the APK from the Artifacts section" >> $GITHUB_STEP_SUMMARY
            echo "2. Install the APK on your test device using: \`adb install -r app-*.apk\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Test the app functionality" >> $GITHUB_STEP_SUMMARY
            echo "4. Create patches for this release using: \`shorebird patch android --flavor ${{ steps.environment_config.outputs.environment }} --dart-define=ENVIRONMENT=${{ steps.environment_config.outputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build Status:** Failed" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify Build Status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "Shorebird release successful - Version: ${{ steps.shorebird-release.outputs.full_version }}"
          else
            echo "Shorebird release failed - check logs for details"
          fi

